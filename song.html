<!doctype html>
<html lang="en" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#f7b5c1" />
    <title>Song</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&family=El+Messiri:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-1: #fef0f3;
        --bg-2: #fcd8e0;
        --bg-3: #f9c1cc;
        --bg-4: #f5aabb;
        --rose: #e07689;
        --rose-2: #d45b72;
        --rose-3: #c94762;
        --text: #3a2a30;
        --text-soft: rgba(58, 42, 48, 0.72);
        --glass: rgba(255, 255, 255, 0.72);
        --glass-2: rgba(255, 255, 255, 0.56);
        --border: rgba(255, 255, 255, 0.86);
        --border-2: rgba(201, 71, 98, 0.16);
        --shadow: 0 12px 40px rgba(201, 71, 98, 0.12), 0 4px 12px rgba(201, 71, 98, 0.06);
        --shadow-lg: 0 20px 60px rgba(201, 71, 98, 0.16), 0 8px 24px rgba(201, 71, 98, 0.1);
        --radius: 28px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Cairo', system-ui, -apple-system, 'Segoe UI', sans-serif;
        color: var(--text);
        background: linear-gradient(140deg, var(--bg-1), var(--bg-2), var(--bg-3));
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .app {
        max-width: 430px;
        height: 100%;
        margin: 0 auto;
        position: relative;
        isolation: isolate;
      }

      .bg {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
      }

      .bg__gradient {
        position: absolute;
        inset: -18%;
        background: linear-gradient(
          135deg,
          #fef0f3 0%,
          #fcd8e0 22%,
          #f9c1cc 46%,
          #f5aabb 74%,
          #f2a3b3 100%
        );
        background-size: 300% 300%;
        opacity: 0.95;
        filter: blur(2px);
        animation: gradientFlow 20s ease-in-out infinite;
      }

      @keyframes gradientFlow {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .bg__orbs {
        position: absolute;
        inset: -30%;
        filter: blur(70px);
        opacity: 0.38;
        mix-blend-mode: soft-light;
      }

      .bg__orbs::before,
      .bg__orbs::after {
        content: '';
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent 65%);
      }

      .bg__orbs::before {
        width: 520px;
        height: 520px;
        top: -10%;
        left: -16%;
        animation: orbFloat1 26s ease-in-out infinite;
      }

      .bg__orbs::after {
        width: 420px;
        height: 420px;
        bottom: -12%;
        right: -12%;
        background: radial-gradient(circle, rgba(228, 116, 138, 0.65), transparent 62%);
        animation: orbFloat2 30s ease-in-out infinite;
      }

      @keyframes orbFloat1 {
        0%,
        100% {
          transform: translate3d(0, 0, 0) scale(1);
        }
        50% {
          transform: translate3d(32px, -42px, 0) scale(1.12);
        }
      }

      @keyframes orbFloat2 {
        0%,
        100% {
          transform: translate3d(0, 0, 0) scale(1);
        }
        50% {
          transform: translate3d(-42px, 34px, 0) scale(1.16);
        }
      }

      .float-hearts {
        position: absolute;
        inset: 0;
        overflow: hidden;
        opacity: 0.85;
      }

      .fh {
        position: absolute;
        width: 20px;
        height: 20px;
        opacity: 0;
        filter: blur(0.5px) drop-shadow(0 0 4px rgba(255, 105, 135, 0.22));
        animation: fhFloat var(--dur) linear var(--delay) infinite;
      }

      .fh::before,
      .fh::after {
        content: '';
        position: absolute;
        width: 11px;
        height: 16px;
        background: radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.7), transparent 60%),
          linear-gradient(180deg, rgba(255, 182, 193, 0.95), rgba(228, 116, 138, 0.82));
        border-radius: 999px 999px 3px 3px;
        box-shadow: 0 2px 8px rgba(201, 71, 98, 0.16);
      }

      .fh::before {
        left: 5px;
        top: 2px;
        transform: rotate(-40deg);
      }

      .fh::after {
        left: 0;
        top: 2px;
        transform: rotate(40deg);
      }

      @keyframes fhFloat {
        0% {
          transform: translate3d(0, 120%, 0) rotate(10deg);
          opacity: 0;
        }
        10% {
          opacity: 0.15;
        }
        90% {
          opacity: 0.15;
        }
        100% {
          transform: translate3d(0, -30%, 0) rotate(20deg);
          opacity: 0;
        }
      }

      .stage {
        position: relative;
        z-index: 1;
        height: 100%;
        display: grid;
        grid-template-rows: auto 1fr auto;
        align-items: center;
        padding: 28px 18px 24px;
        gap: 16px;
      }

      .title {
        margin: 0;
        text-align: center;
        font-family: 'El Messiri', 'Cairo', serif;
        font-weight: 700;
        font-size: 24px;
        letter-spacing: 0.3px;
      }

      .hint {
        margin: 0;
        text-align: center;
        font-weight: 800;
        letter-spacing: 0.16em;
        font-size: 12px;
        color: rgba(58, 42, 48, 0.55);
      }

      .scratch-wrap {
        width: 100%;
        display: grid;
        place-items: center;
      }

      .scratch-card {
        width: 100%;
        max-width: 380px;
        border-radius: var(--radius);
        background: var(--glass);
        border: 1.5px solid var(--border);
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(28px);
        -webkit-backdrop-filter: blur(28px);
        overflow: hidden;
        position: relative;
      }

      .scratch-card__inner {
        padding: 18px;
        display: grid;
        gap: 14px;
      }

      .player {
        border-radius: calc(var(--radius) - 10px);
        background: rgba(255, 255, 255, 0.58);
        border: 1px solid rgba(201, 71, 98, 0.15);
        box-shadow: var(--shadow);
        padding: 14px 14px 12px;
        position: relative;
        overflow: hidden;
      }

      .player::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), transparent 50%);
        pointer-events: none;
      }

      .player__row {
        display: grid;
        grid-template-columns: 56px 1fr;
        gap: 12px;
        align-items: center;
        position: relative;
        z-index: 1;
      }

      .play {
        width: 56px;
        height: 56px;
        border-radius: 18px;
        border: 0;
        background: linear-gradient(135deg, var(--rose), var(--rose-2), var(--rose-3));
        color: #fff;
        box-shadow: 0 12px 26px rgba(201, 71, 98, 0.22);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        display: grid;
        place-items: center;
        transition: transform 0.2s ease, filter 0.25s ease;
      }

      .play:active {
        transform: scale(0.97);
      }

      .play[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .play__icon {
        font-size: 20px;
        line-height: 1;
        transform: translateX(1px);
      }

      .controls {
        display: grid;
        gap: 10px;
      }

      .bar {
        display: grid;
        gap: 6px;
      }

      .time {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: rgba(58, 42, 48, 0.7);
      }

      input[type='range'] {
        width: 100%;
        accent-color: var(--rose-2);
      }

      .vol {
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: 10px;
      }

      .vol__label {
        font-size: 12px;
        color: rgba(58, 42, 48, 0.65);
        font-weight: 700;
      }

      .lock {
        font-size: 13px;
        color: rgba(58, 42, 48, 0.65);
        line-height: 1.8;
        text-align: center;
        padding: 6px 10px 0;
      }

      .lock strong {
        color: rgba(201, 71, 98, 0.95);
      }

      .overlay {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        overflow: hidden;
        z-index: 5;
      }

      canvas#scratch {
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }

      .overlay__label {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        text-align: center;
        padding: 22px;
        pointer-events: none;
      }

      .overlay__pill {
        max-width: 280px;
        width: 100%;
        border-radius: 999px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.66);
        border: 1px solid rgba(201, 71, 98, 0.18);
        box-shadow: var(--shadow);
        font-family: 'El Messiri', 'Cairo', serif;
        font-weight: 700;
        letter-spacing: 0.22em;
        font-size: 12px;
        color: rgba(58, 42, 48, 0.72);
      }

      .back {
        width: 100%;
        max-width: 380px;
        border: 0;
        cursor: pointer;
        border-radius: 999px;
        padding: 14px 22px;
        background: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(201, 71, 98, 0.16);
        box-shadow: var(--shadow);
        color: rgba(58, 42, 48, 0.9);
        font-weight: 800;
        letter-spacing: 0.08em;
        transition: transform 0.18s ease, filter 0.25s ease;
      }

      .back:active {
        transform: scale(0.985);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      @media (prefers-reduced-motion: reduce) {
        .bg__gradient,
        .bg__orbs::before,
        .bg__orbs::after,
        .fh {
          animation: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="bg" aria-hidden="true">
        <div class="bg__gradient"></div>
        <div class="bg__orbs"></div>
        <div class="float-hearts" aria-hidden="true">
          <span class="fh" style="left: 10%; --dur: 18s; --delay: -4s"></span>
          <span class="fh" style="left: 22%; --dur: 24s; --delay: -12s"></span>
          <span class="fh" style="left: 34%; --dur: 20s; --delay: -9s"></span>
          <span class="fh" style="left: 48%; --dur: 27s; --delay: -16s"></span>
          <span class="fh" style="left: 62%; --dur: 22s; --delay: -11s"></span>
          <span class="fh" style="left: 76%; --dur: 25s; --delay: -18s"></span>
          <span class="fh" style="left: 88%; --dur: 19s; --delay: -7s"></span>
          <span class="fh" style="left: 15%; --dur: 30s; --delay: -20s"></span>
          <span class="fh" style="left: 55%; --dur: 32s; --delay: -22s"></span>
          <span class="fh" style="left: 80%; --dur: 28s; --delay: -15s"></span>
        </div>
      </div>

      <main class="stage" id="stage">
        <h1 class="title">أغنية ليك يا قمر</h1>

        <div class="scratch-wrap">
          <section class="scratch-card" aria-label="Song scratch card">
            <div class="scratch-card__inner">
              <div class="player" id="player">
                <div class="player__row">
                  <button class="play" id="playBtn" type="button" disabled>
                    <span class="play__icon" id="playIcon" aria-hidden="true">▶</span>
                    <span class="sr-only">Play</span>
                  </button>

                  <div class="controls" aria-label="Song controls">
                    <div class="bar">
                      <input id="seek" type="range" min="0" max="100" value="0" step="0.1" disabled />
                      <div class="time" aria-hidden="true">
                        <span id="curTime">0:00</span>
                        <span id="durTime">0:00</span>
                      </div>
                    </div>

                    <div class="vol">
                      <div class="vol__label">VOL</div>
                      <input id="vol" type="range" min="0" max="1" value="0.6" step="0.01" disabled />
                    </div>
                  </div>
                </div>

                <div class="lock" id="lockHint">Scratch a bit to <strong>unlock</strong> the song.</div>
              </div>
            </div>

            <div class="overlay" id="overlay" aria-label="Scratch overlay">
              <canvas id="scratch"></canvas>
              <div class="overlay__label" aria-hidden="true">
                <div class="overlay__pill">SCRATCH Here</div>
              </div>
            </div>
          </section>
        </div>

        <!-- <p class="hint">SCRATCH IT</p> -->

        <button class="back" id="back" type="button">الرجوع</button>

        <audio id="audio" src="music/damma.mp3" preload="none"></audio>
      </main>
    </div>

    <script>
      (() => {
        const overlay = document.getElementById('overlay');
        const canvas = document.getElementById('scratch');
        const audio = document.getElementById('audio');

        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const seek = document.getElementById('seek');
        const vol = document.getElementById('vol');
        const curTime = document.getElementById('curTime');
        const durTime = document.getElementById('durTime');
        const lockHint = document.getElementById('lockHint');
        const back = document.getElementById('back');

        if (!overlay || !canvas || !audio) return;

        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        if (!ctx) return;

        const prefersReducedMotion = () => {
          return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        };

        let isDown = false;
        let last = null;
        let unlocked = false;
        let scratchW = 0;
        let scratchH = 0;

        function resizeCanvas() {
          const rect = overlay.getBoundingClientRect();
          const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

          scratchW = Math.floor(rect.width);
          scratchH = Math.floor(rect.height);

          canvas.width = Math.floor(rect.width * dpr);
          canvas.height = Math.floor(rect.height * dpr);
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';

          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

          // Draw overlay fill
          const grad = ctx.createLinearGradient(0, 0, scratchW, scratchH);
          grad.addColorStop(0, 'rgba(255,255,255,0.96)');
          grad.addColorStop(1, 'rgba(255,245,248,0.92)');

          ctx.globalCompositeOperation = 'source-over';
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, scratchW, scratchH);

          // Soft sparkle/noise
          ctx.fillStyle = 'rgba(201,71,98,0.06)';
          for (let i = 0; i < 40; i += 1) {
            const x = Math.random() * scratchW;
            const y = Math.random() * scratchH;
            const r = 0.6 + Math.random() * 1.6;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
          }

          // Border highlight
          ctx.strokeStyle = 'rgba(201,71,98,0.14)';
          ctx.lineWidth = 2;
          ctx.strokeRect(1, 1, scratchW - 2, scratchH - 2);

          ctx.globalCompositeOperation = 'destination-out';
        }

        function pointFromEvent(e) {
          const rect = overlay.getBoundingClientRect();
          const p = e.touches ? e.touches[0] : e;
          return {
            x: (p.clientX - rect.left),
            y: (p.clientY - rect.top)
          };
        }

        function scratchDot(x, y) {
          const r = 18;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fill();

          if (!prefersReducedMotion()) {
            // tiny sparkle
            ctx.save();
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = 'rgba(255,255,255,0.18)';
            ctx.beginPath();
            ctx.arc(x + (Math.random() * 10 - 5), y + (Math.random() * 10 - 5), 1.2 + Math.random() * 1.8, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();

            ctx.globalCompositeOperation = 'destination-out';
          }
        }

        function scratchLine(a, b) {
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const dist = Math.max(1, Math.hypot(dx, dy));
          const step = 6;
          const n = Math.ceil(dist / step);

          for (let i = 0; i <= n; i += 1) {
            const t = i / n;
            scratchDot(a.x + dx * t, a.y + dy * t);
          }
        }

        function clearedRatio() {
          // Sample a sparse grid for performance
          const step = 14;
          const img = ctx.getImageData(0, 0, scratchW, scratchH).data;

          let total = 0;
          let cleared = 0;

          for (let y = 0; y < scratchH; y += step) {
            for (let x = 0; x < scratchW; x += step) {
              total += 1;
              const idx = (y * scratchW + x) * 4 + 3;
              const a = img[idx];
              if (a < 40) cleared += 1;
            }
          }

          return total ? cleared / total : 0;
        }

        function setUnlocked() {
          if (unlocked) return;
          unlocked = true;

          overlay.style.transition = 'opacity 600ms ease';
          overlay.style.opacity = '0';
          overlay.style.pointerEvents = 'none';

          if (playBtn) playBtn.disabled = false;
          if (seek) seek.disabled = false;
          if (vol) vol.disabled = false;

          if (lockHint) {
            lockHint.textContent = 'Now press play.';
          }
        }

        function start(e) {
          isDown = true;
          last = pointFromEvent(e);
          scratchDot(last.x, last.y);
          e.preventDefault();
        }

        function move(e) {
          if (!isDown) return;
          const p = pointFromEvent(e);
          if (last) scratchLine(last, p);
          last = p;
          e.preventDefault();

          if (!unlocked) {
            const ratio = clearedRatio();
            if (ratio >= 0.22) {
              setUnlocked();
            } else if (lockHint && ratio > 0.05) {
              lockHint.textContent = 'Keep scratching...';
            }
          }
        }

        function end() {
          isDown = false;
          last = null;
        }

        function fmtTime(sec) {
          if (!isFinite(sec) || sec < 0) return '0:00';
          const m = Math.floor(sec / 60);
          const s = Math.floor(sec % 60);
          return `${m}:${String(s).padStart(2, '0')}`;
        }

        function syncTimes() {
          if (!audio) return;
          if (curTime) curTime.textContent = fmtTime(audio.currentTime);
          if (durTime) durTime.textContent = fmtTime(audio.duration || 0);
          if (seek && audio.duration) {
            seek.value = String((audio.currentTime / audio.duration) * 100);
          }
        }

        function playPause() {
          if (!unlocked) return;
          if (!audio) return;

          if (audio.paused) {
            audio.play().catch(() => {});
          } else {
            audio.pause();
          }
        }

        function updatePlayIcon() {
          if (!playIcon || !audio) return;
          playIcon.textContent = audio.paused ? '▶' : '❚❚';
        }

        function hookAudio() {
          if (!audio) return;

          audio.addEventListener('loadedmetadata', () => {
            if (durTime) durTime.textContent = fmtTime(audio.duration);
            syncTimes();
          });

          audio.addEventListener('timeupdate', syncTimes);
          audio.addEventListener('play', updatePlayIcon);
          audio.addEventListener('pause', updatePlayIcon);
          audio.addEventListener('ended', updatePlayIcon);

          if (vol) {
            audio.volume = Number(vol.value || 0.6);
            vol.addEventListener('input', () => {
              audio.volume = Number(vol.value || 0);
            });
          }

          if (seek) {
            seek.addEventListener('input', () => {
              if (!audio.duration) return;
              const pct = Number(seek.value || 0) / 100;
              audio.currentTime = pct * audio.duration;
            });
          }

          if (playBtn) {
            playBtn.addEventListener('click', () => {
              playPause();
            });
          }

          updatePlayIcon();
        }

        function init() {
          resizeCanvas();
          hookAudio();

          window.addEventListener('resize', resizeCanvas, { passive: true });

          const opts = { passive: false };
          overlay.addEventListener('touchstart', start, opts);
          overlay.addEventListener('touchmove', move, opts);
          overlay.addEventListener('touchend', end, { passive: true });

          overlay.addEventListener('pointerdown', start, opts);
          overlay.addEventListener('pointermove', move, opts);
          overlay.addEventListener('pointerup', end, { passive: true });
          overlay.addEventListener('pointercancel', end, { passive: true });

          if (back) {
            back.addEventListener('click', () => {
              window.location.href = 'index.html#gallery';
            });
          }
        }

        init();
      })();
    </script>
  </body>
</html>
